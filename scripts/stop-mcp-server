#!/usr/bin/env bash
# Stop Vidurai MCP server
# v2.0 - Phase 2

set -euo pipefail

PID_FILE="$HOME/.vidurai/mcp-server.pid"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

if [ ! -f "$PID_FILE" ]; then
    echo -e "${YELLOW}No server PID file found${NC}"
    echo "Server is not running (or wasn't started with start-mcp-server)"
    exit 1
fi

PID=$(cat "$PID_FILE")

if ps -p $PID > /dev/null 2>&1; then
    echo "ðŸ›‘ Stopping Vidurai MCP Server (PID: $PID)..."
    kill $PID

    # Wait for graceful shutdown
    for i in {1..5}; do
        if ! ps -p $PID > /dev/null 2>&1; then
            break
        fi
        sleep 1
    done

    # Force kill if still running
    if ps -p $PID > /dev/null 2>&1; then
        echo "   Force killing..."
        kill -9 $PID
    fi

    rm "$PID_FILE"
    echo -e "${GREEN}âœ… Server stopped${NC}"
else
    echo -e "${YELLOW}Server not running (stale PID file)${NC}"
    rm "$PID_FILE"
fi
